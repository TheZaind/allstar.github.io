<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Quiz Selection Menu -->
    <div id="quiz-selection-menu" class="quiz-selection-menu">
        <h1 class="main-title">🎮 Maurice's Learning Game</h1>
        <p class="main-subtitle">Wähle ein Quiz-Thema und verbessere dein Wissen</p>
        
        <div class="user-stats-summary">
            <div class="stats-item">
                <span class="stats-icon">⭐</span>
                <span class="stats-value" id="menu-total-xp">0</span>
                <span class="stats-label">Gesamt-XP</span>
            </div>
            <div class="stats-item">
                <span class="stats-icon">🏆</span>
                <span class="stats-value" id="menu-badges">0/4</span>
                <span class="stats-label">Badges</span>
            </div>
            <div class="stats-item">
                <span class="stats-icon">📊</span>
                <span class="stats-value" id="menu-level">1</span>
                <span class="stats-label">Level</span>
            </div>
        </div>
        
        <div class="daily-challenge" id="main-daily-challenge">
            <h3>Tägliche Herausforderung</h3>
            <p id="main-daily-challenge-desc">Beantworte 5 Fragen richtig in einem Quiz</p>
            <div class="daily-challenge-status" id="main-daily-challenge-status">0/5 geschafft</div>
            <div class="daily-challenge-reward" id="main-daily-challenge-reward">Belohnung: 50 XP</div>
        </div>
        
        <div class="progress-path">
            <h3>Dein Lernfortschritt 📚</h3>
            <div class="progress-path-line">
                <div class="progress-path-fill" id="main-progress-path-fill"></div>
                <div class="progress-milestone" style="left: 10%" id="main-milestone-1" title="Anfänger">🥉</div>
                <div class="progress-milestone" style="left: 30%" id="main-milestone-2" title="Fortgeschritten">🥈</div>
                <div class="progress-milestone" style="left: 60%" id="main-milestone-3" title="Profi">🥇</div>
                <div class="progress-milestone" style="left: 90%" id="main-milestone-4" title="Meister">👑</div>
            </div>
            <div id="main-path-status" class="path-status">Sammle XP, um auf deinem Lernpfad voranzuschreiten!</div>
        </div>

        <div id="quiz-categories" class="quiz-categories">
            <!-- Wird dynamisch gefüllt -->
        </div>
        
        <div class="menu-footer">
            <button onclick="toggleTheme()" id="theme-toggle-menu" class="theme-btn">🌓 Dark/Light</button>
            <button onclick="showSettings()" class="settings-btn">⚙️ Einstellungen</button>
        </div>
    </div>

    <div id="quiz-content" style="display: none;">
        <div class="controls">
            <button onclick="backToMenu()" class="back-button">↩️ Zurück zum Menü</button>
            <button onclick="toggleTheme()" id="theme-toggle">🌓 Dark/Light Mode</button>
            <button onclick="newQuiz()">🔄 neues Quiz</button>
            <button onclick="toggleStats()">📊 Statistiken</button>
            <button onclick="toggleTimerMode()" id="timer-toggle">⏱️ Zeitmodus</button>
        </div>

        <div class="fixed-header">
            <div class="header-container">
                <h1 class="quiz-title">💻 Hardware Quiz - Maurice Fragt dich! 💁🏻‍♂️</h1>
                <div class="level-info">Level: <span id="level">1</span> 🌟</div>
                
                <div class="quiz-stats">
                    <div class="streak-counter">
                        <span id="streak-text">Aktuelle Serie: 0</span>
                        <span class="streak-flame" id="streak-flame">🔥</span>
                    </div>
                    <div class="score-display">
                        <div class="score" id="score">Punktzahl: 0 Punkte 📊</div>
                        <div id="xp-display">XP: 0/100</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                    <div class="progress-label" id="progress-label">0%</div>
                </div>
            </div>
            <div id="feedback-message"></div>
        </div>

        <div class="timer-container" id="timer-container" style="display: none;">
            <div class="timer-bar" id="timer-bar"></div>
            <div class="time-bonus-indicator" id="time-bonus">+5 XP</div>
            <div class="timer-mode-badge">⏱️ ZEITMODUS</div>
        </div>

        <div id="single-question-container" class="single-question-container">
            <div class="question-header">
                <div class="question-progress">
                    Frage <span id="current-question-number">1</span> von <span id="total-questions">20</span>
                </div>
                <div class="question-category" id="question-category">
                    Kategorie: <span id="current-category">CPU</span>
                </div>
            </div>

            <div class="question-power-ups">
                <div class="power-up" onclick="usePowerUp('removeWrong')">
                    <span class="power-up-icon">❌</span> 2 Falsche
                    <span class="power-up-count" id="removeWrong-count">0</span>
                </div>
                <div class="power-up" onclick="usePowerUp('showHint')">
                    <span class="power-up-icon">💡</span> Hinweis
                    <span class="power-up-count" id="showHint-count">0</span>
                </div>
                <div class="power-up" onclick="usePowerUp('extraTime')">
                    <span class="power-up-icon">⏱️</span> Extra Zeit
                    <span class="power-up-count" id="extraTime-count">0</span>
                </div>
            </div>

            <div id="current-question" class="current-question">
                <!-- Current question will be inserted here -->
            </div>

            <div class="question-navigation">
                <button id="prev-question" onclick="previousQuestion()" disabled>⬅️ Vorherige Frage</button>
                <button id="next-question" onclick="nextQuestion()">Nächste Frage ➡️</button>
            </div>
        </div>

        <div class="hint-container">
            <div class="hint-coins">
                <span class="hint-coins-icon">🪙</span>
                <span id="hint-coins-count">0</span> Münzen
            </div>
            <div class="hint-buttons">
                <button class="hint-button" onclick="buyPowerUp('removeWrong')">
                    <span class="hint-button-icon">❌</span> 2 Falsche entfernen (10 🪙)
                </button>
                <button class="hint-button" onclick="buyPowerUp('showHint')">
                    <span class="hint-button-icon">💡</span> Hinweis zeigen (5 🪙)
                </button>
                <button class="hint-button" onclick="buyPowerUp('extraTime')">
                    <span class="hint-button-icon">⏱️</span> Extra Zeit (8 🪙)
                </button>
            </div>
        </div>

        <div class="game-progress">
            <div class="badge-container" id="badge-container">
                <div class="badge" id="badge-beginner">
                    <div class="badge-icon">🥉</div>
                    <div class="badge-name">Anfänger (100 XP)</div>
                </div>
                <div class="badge" id="badge-intermediate">
                    <div class="badge-icon">🥈</div>
                    <div class="badge-name">Fortgeschritten (350 XP)</div>
                </div>
                <div class="badge" id="badge-advanced">
                    <div class="badge-icon">🥇</div>
                    <div class="badge-name">Profi (750 XP)</div>
                </div>
                <div class="badge" id="badge-master">
                    <div class="badge-icon">👑</div>
                    <div class="badge-name">Meister (1500 XP)</div>
                </div>
            </div>
        </div>

        <div class="stats-container hidden" id="stats-container">
            <h2>Deine Statistiken 📈</h2>
            <p>Gespielte Quizze: <span id="total-quizzes">0</span></p>
            <p>Korrekte Antworten: <span id="total-correct">0</span></p>
            <p>Durchschnittliche Punktzahl: <span id="average-score">0</span></p>
            <p>Längste Streak: <span id="best-streak">0</span></p>
            <p>Verdiente Badges: <span id="earned-badges">0</span>/4</p>
        </div>

        <!-- Achievement popup -->
        <div class="achievement-popup" id="achievement-popup">
            <h2 id="achievement-title">Achievement Unlocked!</h2>
            <div class="badge-icon" id="achievement-icon">🏆</div>
            <button onclick="closeAchievementPopup()">Ok</button>
        </div>
        <div class="overlay" id="overlay"></div>

        <!-- Bonus-Popup -->
        <div class="bonus-popup" id="bonus-popup"></div>
    </div>

    <style>
        .quiz-selection-menu {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            text-align: center;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .main-title {
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
            color: var(--primary-color);
            animation: fadeIn 0.8s ease;
        }

        .main-subtitle {
            color: var(--secondary-color);
            margin-bottom: 2rem;
            font-size: 1.2rem;
        }

        .user-stats-summary {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: 8px;
            animation: slideIn 0.6s ease;
        }

        .stats-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stats-icon {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
        }

        .stats-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stats-label {
            font-size: 0.8rem;
            color: var(--secondary-color);
        }


        .daily-challenge-status, .total-xp {
            color: var(--primary-color);
        }

        .quiz-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            animation: fadeIn 1s ease;
        }

        .quiz-category {
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .quiz-category:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .quiz-category h3 {
            margin: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quiz-category-icon {
            font-size: 1.6rem;
        }

        .quiz-category p {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .category-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .category-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .category-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%; /* Wird dynamisch gesetzt */
            height: 4px;
            background-color: var(--primary-color);
            transition: width 0.6s ease;
        }
        
        #single-question-container {
            margin: 2rem auto;
            max-width: 800px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .menu-footer {
            margin-top: 3rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .theme-btn, .settings-btn {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-btn:hover, .settings-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .quiz-selection-menu {
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .user-stats-summary {
                gap: 1rem;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .quiz-categories {
                grid-template-columns: 1fr;
            }
        }
        
        .single-question-container {
            background-color: var(--container-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin: 2rem auto;
            max-width: 800px;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .question-progress {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .question-category {
            font-size: 1rem;
            color: var(--secondary-color);
        }

        .current-question {
            margin: 2rem 0;
        }

        .question-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        #prev-question, #next-question {
            min-width: 150px;
        }

        #prev-question:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    </style>

    <script>
    // Theme toggle functionality
    let darkMode = localStorage.getItem('darkMode') === 'true';

    function toggleTheme() {
        darkMode = !darkMode;
        document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
        localStorage.setItem('darkMode', darkMode);
    }

    // Game data saving and loading
    function saveGameData() {
        const gameData = {
            totalXP,
            level,
            currentStreak,
            bestStreak,
            totalCorrect,
            totalQuestions,
            totalQuizzes,
            darkMode,
            badges: {}, // Add your badges here
            hintCoins,
            powerUps: {
                removeWrong: document.getElementById('removeWrong-count').textContent,
                showHint: document.getElementById('showHint-count').textContent,
                extraTime: document.getElementById('extraTime-count').textContent
            }
        };
        
        localStorage.setItem('quizGameData', JSON.stringify(gameData));
    }

    function loadSavedData() {
        const savedData = localStorage.getItem('quizGameData');
        if (savedData) {
            const data = JSON.parse(savedData);
            totalXP = data.totalXP || 0;
            level = data.level || 1;
            currentStreak = data.currentStreak || 0;
            bestStreak = data.bestStreak || 0;
            totalCorrect = data.totalCorrect || 0;
            totalQuestions = data.totalQuestions || 0;
            totalQuizzes = data.totalQuizzes || 0;
            darkMode = data.darkMode ?? true;
            hintCoins = data.hintCoins || 0;
            
            // Update UI with loaded data
            document.getElementById('total-xp').textContent = totalXP;
            document.getElementById('level').textContent = level;
            document.getElementById('menu-level').textContent = level;
            document.getElementById('menu-total-xp').textContent = totalXP;
            updateStreak(false);
            updateProgressBar();
            updateLevel();
            updateHintSystem();
            
            // Load power-ups
            if (data.powerUps) {
                document.getElementById('removeWrong-count').textContent = data.powerUps.removeWrong || 0;
                document.getElementById('showHint-count').textContent = data.powerUps.showHint || 0;
                document.getElementById('extraTime-count').textContent = data.powerUps.extraTime || 0;
            }
        }
    }

    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
        loadSavedData();
    });
    
    // Verfügbare Quiz-Kategorien und globale Variablen
    let questions = []; // Global questions array
    let currentQuestionIndex = 0;
    let answeredQuestions = new Set();
    
    // Quiz-Kategorien
    const quizCategories = [
        {
            id: 'cpu',
            name: 'CPU Quiz',
            description: 'Teste dein Wissen über Prozessoren und CPU-Architektur',
            icon: '💻',
            file: 'cpu.json'
        },
        {
            id: 'mb',
            name: 'MainBoard Quiz',
            description: 'Teste dein Wissen über Hauptplatinen, Komponenten und ihre Funktionen',
            icon: '🔌',
            file: 'mainboard.json'
        },
        {
            id: 'gw',
            name: 'Elektrogrundlagen Quiz',
            description: 'Grundlegendes Wissen über elektrische Konzepte und Komponenten',
            icon: '⚡',
            file: 'grundwissen.json'
        },
        {
            id: 'mix',
            name: 'Gemischtes Quiz',
            description: 'Eine herausfordernde Mischung aus allen Kategorien für echte Profis',
            icon: '🔄',
            file: null // Spezialfall für gemischtes Quiz
        }
    ];

    // Initialisierung
    document.addEventListener('DOMContentLoaded', async function() {
        // Set initial theme
        document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
        
        // Load saved data
        loadSavedData();
        
        // Show quiz selection menu
        showQuizMenu();
        
        // Initialize quiz categories
        await initializeQuizCategories();
    });

    // Initialize quiz categories
    async function initializeQuizCategories() {
        const categoriesContainer = document.getElementById('quiz-categories');
        categoriesContainer.innerHTML = quizCategories.map(category => `
            <div class="quiz-category" onclick="startQuizCategory('${category.id}')">
                <h3><span class="quiz-category-icon">${category.icon}</span> ${category.name}</h3>
                <p>${category.description}</p>
                <div class="category-stats">
                    <div class="category-stat">
                        <span>🎮</span> 0x gespielt
                    </div>
                    <div class="category-stat">
                        <span>🏅</span> Highscore: 0/20
                    </div>
                </div>
                <div class="category-progress"></div>
            </div>
        `).join('');
    }

    // Start specific quiz category
    async function startQuizCategory(categoryId) {
        try {
            const category = quizCategories.find(c => c.id === categoryId);
            if (!category) throw new Error('Kategorie nicht gefunden');

            if (category.id === 'mix') {
                // Lade alle Quizfragen von allen Kategorien
                questions = [];
                for (const cat of quizCategories) {
                    if (cat.id !== 'mix' && cat.file) {
                        const response = await fetch(cat.file);
                        if (response.ok) {
                            const data = await response.json();
                            // Füge Kategorie-Info zu jeder Frage hinzu
                            const questionsWithCategory = data.questions.map(q => ({
                                ...q,
                                categoryId: cat.id,
                                categoryName: cat.name
                            }));
                            questions.push(...questionsWithCategory);
                        }
                    }
                }
            } else {
                const response = await fetch(category.file);
                if (!response.ok) throw new Error(`Fehler beim Laden von ${category.file}`);

                const data = await response.json();
                questions = data.questions.map(q => ({
                    ...q,
                    categoryId: category.id,
                    categoryName: category.name
                }));
            }

            // Hide menu and show quiz
            document.getElementById('quiz-selection-menu').style.display = 'none';
            document.getElementById('quiz-content').style.display = 'block';

            // Start new quiz
            createQuiz();
        } catch (error) {
            console.error('Fehler beim Laden der Fragen:', error);
            showError('Fehler beim Laden der Fragen. Bitte aktualisiere die Seite.');
        }
    }

    function createQuiz() {
        currentQuestionIndex = 0;
        answeredQuestions.clear();
        currentQuestions = selectRandomQuestions();
        score = 0;
        document.getElementById('score').textContent = 'Punktzahl: 0 Punkte 📊';
        updateProgressBar();
        displayCurrentQuestion();
        
        // Update total questions display
        document.getElementById('total-questions').textContent = currentQuestions.length;
    }

    // Show quiz menu
    function showQuizMenu() {
        document.getElementById('quiz-selection-menu').style.display = 'block';
        document.getElementById('quiz-content').style.display = 'none';
    }

    // Fragen laden und Quiz initialisieren
    let currentQuestions = [];
    let score = 0;
    let xp = 0;
    let totalXP = 0;
    let level = 1;
    let currentStreak = 0;
    let bestStreak = 0;
    let totalCorrect = 0;
    let totalQuestions = 0;
    let totalQuizzes = 0;
    let timerActive = false;
    let timerInterval;
    let maxTime = 30; // Sekunden pro Frage
    let timeRemaining;

    // Wähle zufällige Fragen für das Quiz
    function selectRandomQuestions(amount = 20) {
        let availableQuestions = [...questions];
        let selectedQuestions = [];
        
        while (selectedQuestions.length < amount && availableQuestions.length > 0) {
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            selectedQuestions.push(availableQuestions[randomIndex]);
            availableQuestions.splice(randomIndex, 1);
        }
        
        return selectedQuestions;
    }

    // Lade die Fragen beim Start
    async function loadQuestions() {
        try {
            const response = await fetch('cpu.json');
            if (!response.ok) {
                throw new Error('Fehler beim Laden der Fragen');
            }
            const data = await response.json();
            questions = data.questions;
            loadSavedData();
            createQuiz();
        } catch (error) {
            console.error('Fehler beim Laden der Fragen:', error);
            document.getElementById('quiz-container').innerHTML = 
                '<div class="error-message">Fehler beim Laden der Fragen. Bitte aktualisiere die Seite.</div>';
        }
    }

    // Neues Quiz starten
    function newQuiz() {
        currentQuestions = selectRandomQuestions();
        currentQuestionIndex = 0;
        answeredQuestions.clear();
        score = 0;
        document.getElementById('score').textContent = 'Punktzahl: 0 Punkte 📊';
        updateProgressBar();
        displayCurrentQuestion();
        
        // Update total questions display
        document.getElementById('total-questions').textContent = currentQuestions.length;
    }

    // Verbesserte Navigation zwischen den Fragen
    function displayCurrentQuestion() {
        const container = document.getElementById('current-question');
        const question = currentQuestions[currentQuestionIndex];
        
        // Füge Slide-Out Animation hinzu
        container.classList.add('slide-out');
        
        setTimeout(() => {
            // Update question number and category
            document.getElementById('current-question-number').textContent = currentQuestionIndex + 1;
            
            if (question.categoryId) {
                document.getElementById('current-category').textContent = 
                    quizCategories.find(c => c.id === question.categoryId)?.name || 'Allgemein';
            }

            // Randomize options with animation delay
            const originalCorrectIndex = question.correct;
            const optionsCopy = [...question.options];
            const randomizedOptions = [];
            const optionMapping = [];
            
            while (optionsCopy.length > 0) {
                const randIndex = Math.floor(Math.random() * optionsCopy.length);
                const originalIndex = question.options.indexOf(optionsCopy[randIndex]);
                randomizedOptions.push(optionsCopy[randIndex]);
                optionMapping.push(originalIndex);
                optionsCopy.splice(randIndex, 1);
            }
            
            const newCorrectIndex = optionMapping.indexOf(originalCorrectIndex);
            currentQuestions[currentQuestionIndex].randomizedCorrect = newCorrectIndex;

            // Create options with staggered animation
            container.innerHTML = `
                <div class="question-text">${question.question}</div>
                <div class="options-container">
                    ${randomizedOptions.map((option, index) => `
                        <div class="option" 
                            style="--animation-order: ${index}"
                            ${answeredQuestions.has(currentQuestionIndex) ? 
                                `class="option ${index === question.randomizedCorrect ? 'correct' : 
                                (index === question.lastSelected ? 'incorrect' : '')}"` : ''} 
                            onclick="checkAnswer(${currentQuestionIndex}, ${index})"
                            ${answeredQuestions.has(currentQuestionIndex) ? 'style="pointer-events: none;"' : ''}>
                            ${option}
                        </div>
                    `).join('')}


                </div>
            `;

            // Füge Slide-In Animation hinzu
            container.classList.remove('slide-out');
            container.classList.add('slide-in');
            
            // Entferne Animations-Klassen nach Abschluss
            setTimeout(() => {
                container.classList.remove('slide-in');
            }, 500);

        }, 300); // Warte auf Slide-Out Animation

        // Update navigation buttons
        document.getElementById('prev-question').disabled = currentQuestionIndex === 0;
        document.getElementById('next-question').disabled = 
            currentQuestionIndex === currentQuestions.length - 1 || 
            !answeredQuestions.has(currentQuestionIndex);
        
        // Start timer if active
        if (timerActive) {
            startQuestionTimer();
        }
    }

    // Verbesserte Antwortprüfung mit Animation
    function checkAnswer(questionIndex, selectedOption) {
        if (answeredQuestions.has(questionIndex)) return;
        
        const question = currentQuestions[questionIndex];
        const isCorrect = selectedOption === question.randomizedCorrect;
        const options = document.querySelectorAll('.option');
        
        // Deaktiviere alle Optionen während der Animation
        options.forEach(option => {
            option.style.pointerEvents = 'none';
        });
        
        // Markiere die ausgewählte Option
        options[selectedOption].classList.add(isCorrect ? 'correct' : 'incorrect');
        
        if (!isCorrect) {
            // Zeige die richtige Antwort
            setTimeout(() => {
                options[question.randomizedCorrect].classList.add('correct');
            }, 300);
        }

        // Speichere die Antwort und aktualisiere Statistiken
        question.lastSelected = selectedOption;
        answeredQuestions.add(questionIndex);
        totalQuestions++;

        // Stoppe Timer
        clearInterval(timerInterval);

        // Verarbeite das Ergebnis
        processAnswer(isCorrect, questionIndex);
        
        // Aktiviere den "Weiter"-Button
        document.getElementById('next-question').disabled = 
            currentQuestionIndex === currentQuestions.length - 1;
            
        // Automatisch zur nächsten Frage nach Verzögerung
        if (currentQuestionIndex < currentQuestions.length - 1) {
            setTimeout(() => {
                nextQuestion();
            }, 1500);
        } else if (currentQuestionIndex === currentQuestions.length - 1) {
            // Quiz abgeschlossen
            setTimeout(() => {
                showQuizSummary();
            }, 1500);
        }
    }

    // neue Funktion für die Quiz-Zusammenfassung
    function showQuizSummary() {
        const container = document.getElementById('current-question');
        const correctAnswers = Array.from(answeredQuestions).filter(
            index => currentQuestions[index].lastSelected === currentQuestions[index].randomizedCorrect
        ).length;
        
        container.innerHTML = `
            <div class="quiz-summary">
                <h2>Quiz abgeschlossen! 🎉</h2>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <span class="stat-value">${correctAnswers}/${currentQuestions.length}</span>
                        <span class="stat-label">Richtige Antworten</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-value">${Math.round((correctAnswers/currentQuestions.length) * 100)}%</span>
                        <span class="stat-label">Erfolgsquote</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-value">+${totalXP}</span>
                        <span class="stat-label">Gewonnene XP</span>
                    </div>
                </div>
                <button onclick="newQuiz()" class="retry-button">🔄 Neues Quiz starten</button>
            </div>
        `;
    }

    // Verbesserte Navigation
    function nextQuestion() {
        if (currentQuestionIndex < currentQuestions.length - 1) {
            currentQuestionIndex++;
            displayCurrentQuestion();
        }
    }

    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayCurrentQuestion();
        }
    }

    function backToMenu() {
        // Reset quiz state
        currentQuestions = [];
        currentQuestionIndex = 0;
        answeredQuestions.clear();
        score = 0;
        
        // Clear timer if active
        if (timerActive) {
            clearInterval(timerInterval);
            timerActive = false;
            document.getElementById('timer-container').style.display = 'none';
            document.getElementById('timer-toggle').style.backgroundColor = 'var(--primary-color)';
        }
        
        // Hide quiz content and show menu
        document.getElementById('quiz-content').style.display = 'none';
        document.getElementById('quiz-selection-menu').style.display = 'block';
        
        // Save current game state
        saveGameData();
    }
    
    // Verarbeitung der Antwort in separate Funktion ausgelagert
    function processAnswer(isCorrect, questionIndex) {
        if (isCorrect) {
            score++;
            totalCorrect++;
            
            const basePoints = 5;
            const streakBonus = currentStreak > 0 ? Math.min(5, currentStreak) : 0;
            const levelBonus = Math.floor(level / 2);
            
            let timeBonus = 0;
            if (timerActive && timeRemaining > 0) {
                timeBonus = Math.ceil(timeRemaining / maxTime * 5);
                showTimeBonus(timeBonus);
            }
            
            const xpGained = basePoints + streakBonus + levelBonus + timeBonus;
            xp += xpGained;
            totalXP += xpGained;
            
            const coinsEarned = 1 + Math.floor(level / 3);
            hintCoins += coinsEarned;
            
            updateUI(xpGained, streakBonus, timeBonus, coinsEarned);
            updateDailyChallenge('correct_answer');
            checkForBadges();
        } else {
            showFeedback(getRandomFeedback(false), false);
        }
        
        updateStreak(isCorrect);
        updateDailyChallenge('streak_update');
        saveGameData();
        updateStats();
    }
    
    // UI-Updates in separate Funktion ausgelagert
    function updateUI(xpGained, streakBonus, timeBonus, coinsEarned) {
        // Score-Element aktualisieren
        const scoreElement = document.getElementById('score');
        if (scoreElement) {
            scoreElement.textContent = `Punktzahl: ${score} Punkte 📊`;
            scoreElement.classList.add('pop-animation');
            setTimeout(() => {
                scoreElement.classList.remove('pop-animation');
            }, 500);
        }
        
        // Total XP aktualisieren
        const totalXpElement = document.getElementById('total-xp');
        if (totalXpElement) {
            totalXpElement.textContent = totalXP;
        }
        
        // Aktualisiere alle anderen Elemente
        updateProgressBar();
        updateLevel();
        updateHintSystem();
        updateProgressPath();
        
        // Feedback anzeigen
        let feedbackText = getRandomFeedback(true, xpGained);
        if (streakBonus > 0) feedbackText += ` (+${streakBonus} Streak Bonus)`;
        if (timeBonus > 0) feedbackText += ` (+${timeBonus} Zeit Bonus)`;
        feedbackText += ` (+${coinsEarned} 🪙)`;
        
        showFeedback(feedbackText, true);
    }

    // Hilfsfunktionen
    function updateProgressBar() {
        const progress = Math.round((score / currentQuestions.length) * 100);
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('progress-label').textContent = `${progress}%`;
    }

    function updateStreak(isCorrect) {
        if (isCorrect) {
            currentStreak++;
            if (currentStreak > bestStreak) {
                bestStreak = currentStreak;
            }
        } else {
            currentStreak = 0;
        }
        
        document.getElementById('streak-text').textContent = `Aktuelle Serie: ${currentStreak}`;
        const streakFlame = document.getElementById('streak-flame');
        
        if (currentStreak > 0) {
            streakFlame.classList.add('active');
        } else {
            streakFlame.classList.remove('active');
        }
    }

    function updateLevel() {
        const newLevel = Math.floor(totalXP / 100) + 1;
        if (newLevel !== level) {
            level = newLevel;
            document.getElementById('level').textContent = level;
            showAchievement('Neues Level!', `Level ${level} erreicht! 🎉`, '🌟');
        }
        
        const xpToNextLevel = (level * 100) - totalXP;
        document.getElementById('xp-display').textContent = 
            `XP: ${totalXP % 100}/100 (${xpToNextLevel} bis Level ${level + 1})`;
    }

    function updateHintSystem() {
        document.getElementById('hint-coins-count').textContent = hintCoins;
    }

    function updateProgressPath() {
        const pathProgress = (totalXP / 1500) * 100;
        document.getElementById('progress-path-fill').style.width = `${Math.min(100, pathProgress)}%`;
        
        const milestones = [
            { xp: 100, id: 'milestone-1' },
            { xp: 350, id: 'milestone-2' },
            { xp: 750, id: 'milestone-3' },
            { xp: 1500, id: 'milestone-4' }
        ];
        
        milestones.forEach(milestone => {
            const element = document.getElementById(milestone.id);
            if (totalXP >= milestone.xp) {
                element.classList.add('completed');
            } else if (totalXP >= milestone.xp * 0.8) {
                element.classList.add('active');
            }
        });
    }

    function updateStats() {
        document.getElementById('total-quizzes').textContent = totalQuizzes;
        document.getElementById('total-correct').textContent = totalCorrect;
        document.getElementById('average-score').textContent = 
            totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) + '%' : '0%';
        document.getElementById('best-streak').textContent = bestStreak;
    }

    function showFeedback(message, isSuccess) {
        const feedbackEl = document.getElementById('feedback-message');
        feedbackEl.textContent = message;
        feedbackEl.className = isSuccess ? 'feedback-success' : 'feedback-error';
        feedbackEl.style.opacity = '1';
        
        setTimeout(() => {
            feedbackEl.style.opacity = '0';
        }, 3000);
    }

    function getRandomFeedback(isCorrect, xpGained = 0) {
        const correctFeedback = [
            `Super! +${xpGained} XP 🌟`,
            `Richtig! +${xpGained} XP ✨`,
            `Gut gemacht! +${xpGained} XP 🎯`,
            `Perfekt! +${xpGained} XP 💫`,
            `Ausgezeichnet! +${xpGained} XP 🏆`
        ];
        
        const incorrectFeedback = [
            'Leider falsch! Weiter so! 💪',
            'Nicht ganz richtig! Nächste Chance! 🎯',
            'Fast! Probier\'s nochmal! 📚',
            'Nicht aufgeben! 💫',
            'Du schaffst das! 🌟'
        ];
        
        const feedbackArray = isCorrect ? correctFeedback : incorrectFeedback;
        return feedbackArray[Math.floor(Math.random() * feedbackArray.length)];
    }

    function showAchievement(title, description, icon) {
        const popup = document.getElementById('achievement-popup');
        const overlay = document.getElementById('overlay');
        
        document.getElementById('achievement-title').textContent = title;
        document.getElementById('achievement-description').textContent = description;
        document.getElementById('achievement-icon').textContent = icon;
        
        popup.classList.add('show');
        overlay.classList.add('show');
        
        // Optional: Konfetti-Animation
        if (typeof confetti === 'function') {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
    }

    function closeAchievementPopup() {
        const popup = document.getElementById('achievement-popup');
        const overlay = document.getElementById('overlay');
        
        popup.classList.remove('show');
        overlay.classList.remove('show');
    }

    function toggleStats() {
        const statsContainer = document.getElementById('stats-container');
        statsContainer.classList.toggle('hidden');
    }

    function showSettings() {
        alert('Einstellungen werden bald verfügbar sein!');
    }

    function showError(message) {
        const container = document.getElementById('current-question');
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function updateDailyChallenge(action) {
        // Implementierung der täglichen Herausforderungen hier
        // Wird später hinzugefügt
    }

    let hintCoins = 0; // Initialisiere Hint-Münzen

    function buyPowerUp(type) {
        const costs = {
            removeWrong: 10,
            showHint: 5,
            extraTime: 8
        };
        
        if (hintCoins >= costs[type]) {
            hintCoins -= costs[type];
            const count = parseInt(document.getElementById(`${type}-count`).textContent);
            document.getElementById(`${type}-count`).textContent = count + 1;
            updateHintSystem();
            showFeedback(`Power-Up gekauft! (-${costs[type]} 🪙)`, true);
            saveGameData();
        } else {
            showFeedback('Nicht genug Münzen! 💰', false);
        }
    }

    function usePowerUp(type) {
        const count = parseInt(document.getElementById(`${type}-count`).textContent);
        if (count > 0) {
            document.getElementById(`${type}-count`).textContent = count - 1;
            
            switch(type) {
                case 'removeWrong':
                    removeWrongAnswers();
                    break;
                case 'showHint':
                    showCurrentHint();
                    break;
                case 'extraTime':
                    addExtraTime();
                    break;
            }
            
            saveGameData();
        } else {
            showFeedback('Keine Power-Ups verfügbar! 🚫', false);
        }
    }

    function removeWrongAnswers() {
        const currentQuestion = currentQuestions[currentQuestionIndex];
        const options = document.querySelectorAll('.option');
        let removedCount = 0;
        
        options.forEach((option, index) => {
            if (index !== currentQuestion.randomizedCorrect && removedCount < 2) {
                option.style.opacity = '0.3';
                option.style.pointerEvents = 'none';
                removedCount++;
            }
        });
        
        showFeedback('2 falsche Antworten entfernt! 🎯', true);
    }

    function showCurrentHint() {
        const currentQuestion = currentQuestions[currentQuestionIndex];
        if (currentQuestion.hint) {
            showFeedback(`Hinweis: ${currentQuestion.hint} 💡`, true);
        } else {
            showFeedback('Kein Hinweis verfügbar! 🤔', false);
        }
    }

    function addExtraTime() {
        if (timerActive) {
            timeRemaining += 15;
            showFeedback('+15 Sekunden! ⏱️', true);
        } else {
            showFeedback('Timer nicht aktiv! ⏱️', false);
        }
    }

    function toggleTimerMode() {
        timerActive = !timerActive;
        const timerContainer = document.getElementById('timer-container');
        const timerButton = document.getElementById('timer-toggle');
        
        if (timerActive) {
            timerContainer.style.display = 'block';
            timerButton.style.backgroundColor = 'var(--time-color)';
            startQuestionTimer();
        } else {
            timerContainer.style.display = 'none';
            timerButton.style.backgroundColor = 'var(--primary-color)';
            clearInterval(timerInterval);
        }
    }

    function startQuestionTimer() {
        clearInterval(timerInterval);
        timeRemaining = maxTime;
        
        const timerBar = document.getElementById('timer-bar');
        timerBar.style.width = '100%';
        
        timerInterval = setInterval(() => {
            timeRemaining--;
            const percentage = (timeRemaining / maxTime) * 100;
            timerBar.style.width = `${percentage}%`;
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                handleTimeUp();
            }
        }, 1000);
    }

    function handleTimeUp() {
        const currentQuestion = currentQuestions[currentQuestionIndex];
        const options = document.querySelectorAll('.option');
        
        options.forEach(option => {
            option.style.pointerEvents = 'none';
        });
        
        showFeedback('Zeit abgelaufen! ⏰', false);
        options[currentQuestion.randomizedCorrect].classList.add('correct');
        
        setTimeout(() => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                nextQuestion();
            }
        }, 1500);
    }

    function showTimeBonus(bonus) {
        const bonusIndicator = document.getElementById('time-bonus');
        bonusIndicator.textContent = `+${bonus} XP`;
        bonusIndicator.classList.add('show');
        
        setTimeout(() => {
            bonusIndicator.classList.remove('show');
        }, 1500);
    }

    // Füge die fehlende checkForBadges-Funktion hinzu
function checkForBadges() {
    const badgeCriteria = [
        { id: 'badge-beginner', xp: 100, name: 'Anfänger' },
        { id: 'badge-intermediate', xp: 350, name: 'Fortgeschritten' },
        { id: 'badge-advanced', xp: 750, name: 'Profi' },
        { id: 'badge-master', xp: 1500, name: 'Meister' }
    ];
    
    let earnedBadges = 0;
    badgeCriteria.forEach(badge => {
        const badgeElement = document.getElementById(badge.id);
        if (badgeElement && totalXP >= badge.xp) {
            if (!badgeElement.classList.contains('earned')) {
                badgeElement.classList.add('earned');
                showAchievement('Neues Abzeichen!', `Du hast das ${badge.name}-Abzeichen verdient!`, badge.id === 'badge-master' ? '👑' : (badge.id === 'badge-advanced' ? '🥇' : (badge.id === 'badge-intermediate' ? '🥈' : '🥉')));
            }
            earnedBadges++;
        }
    });
    
    // Aktualisiere auch die Badges im Hauptmenü
    const mainProgressPathFill = document.getElementById('main-progress-path-fill');
    if (mainProgressPathFill) {
        const pathProgress = (totalXP / 1500) * 100;
        mainProgressPathFill.style.width = `${Math.min(100, pathProgress)}%`;
        
        const mainMilestones = [
            { xp: 100, id: 'main-milestone-1' },
            { xp: 350, id: 'main-milestone-2' },
            { xp: 750, id: 'main-milestone-3' },
            { xp: 1500, id: 'main-milestone-4' }
        ];
        
        mainMilestones.forEach(milestone => {
            const element = document.getElementById(milestone.id);
            if (element) {
                if (totalXP >= milestone.xp) {
                    element.classList.add('completed');
                } else if (totalXP >= milestone.xp * 0.8) {
                    element.classList.add('active');
                }
            }
        });
    }
    
    // Aktualisiere Badges-Anzeige
    const earnedBadgesElement = document.getElementById('earned-badges');
    if (earnedBadgesElement) {
        earnedBadgesElement.textContent = earnedBadges;
    }
    
    const menuBadgesElement = document.getElementById('menu-badges');
    if (menuBadgesElement) {
        menuBadgesElement.textContent = `${earnedBadges}/4`;
    }
}

// Aktualisiere die showSettings-Funktion
function showSettings() {
    alert('Einstellungen werden bald verfügbar sein!');
}
    
    // Rest of your existing code...
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial theme
        document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
        
        // Load questions and start quiz
        loadQuestions();
    });
    </script>
</body>
</html>
<style>
    .quiz-summary {
        text-align: center;
        padding: 2rem;
        animation: fadeIn 0.5s ease;
    }

    .quiz-summary h2 {
        color: var(--primary-color);
        margin-bottom: 2rem;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
    }

    .summary-stat {
        background: var(--container-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-color);
        display: block;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--secondary-color);
    }

    .retry-button {
        margin-top: 2rem;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        width: auto;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>