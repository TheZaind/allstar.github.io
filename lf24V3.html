<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="fixed-header">
        <div class="header-container">
            <div class="level-info">MauriceÂ´s-Learning-Game Level: <span id="level">1</span> ğŸŒŸ</div>
            <div class="streak-counter">
                <span id="streak-text">Aktuelle Serie: 0</span>
                <span class="streak-flame" id="streak-flame">ğŸ”¥</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
                <div class="progress-label" id="progress-label">0%</div>
            </div>
            <div id="feedback-message"></div>
        </div>
    </div>

    <div class="controls">
        <button onclick="toggleTheme()" id="theme-toggle">ğŸŒ“ Dark/Light Mode</button>
        <button onclick="newQuiz()">ğŸ”„ Neues Quiz</button>
        <button onclick="toggleStats()">ğŸ“Š Statistiken</button>
        <button onclick="toggleTimerMode()" id="timer-toggle">â±ï¸ Zeitmodus</button>
    </div>
    <h1>ğŸ’» Hardware Quiz - Maurice Fragt dich! ğŸ’ğŸ»â€â™‚ï¸</h1>
    
    <!-- Timer Container -->
    <div class="timer-container" id="timer-container" style="display: none;">
        <div class="timer-bar" id="timer-bar"></div>
        <div class="time-bonus-indicator" id="time-bonus">+5 XP</div>
        <div class="timer-mode-badge">â±ï¸ ZEITMODUS</div>
    </div>
    
    <!-- Hinweis-System -->
    <div class="hint-container">
        <div class="hint-coins">
            <span class="hint-coins-icon">ğŸª™</span>
            <span id="hint-coins-count">0</span> MÃ¼nzen
        </div>
        <div class="hint-buttons">
            <button class="hint-button" onclick="buyPowerUp('removeWrong')">
                <span class="hint-button-icon">âŒ</span> 2 Falsche entfernen (10 ğŸª™)
            </button>
            <button class="hint-button" onclick="buyPowerUp('showHint')">
                <span class="hint-button-icon">ğŸ’¡</span> Hinweis zeigen (5 ğŸª™)
            </button>
            <button class="hint-button" onclick="buyPowerUp('extraTime')">
                <span class="hint-button-icon">â±ï¸</span> Extra Zeit (8 ğŸª™)
            </button>
        </div>
    </div>
    
    <!-- Power-Ups -->
    <div class="power-ups">
        <div class="power-up" onclick="usePowerUp('removeWrong')">
            <span class="power-up-icon">âŒ</span> 2 Falsche
            <span class="power-up-count" id="removeWrong-count">0</span>
        </div>
        <div class="power-up" onclick="usePowerUp('showHint')">
            <span class="power-up-icon">ğŸ’¡</span> Hinweis
            <span class="power-up-count" id="showHint-count">0</span>
        </div>
        <div class="power-up" onclick="usePowerUp('extraTime')">
            <span class="power-up-icon">â±ï¸</span> Extra Zeit
            <span class="power-up-count" id="extraTime-count">0</span>
        </div>
    </div>
    
    <!-- TÃ¤gliche Herausforderung -->
    <div class="daily-challenge" id="daily-challenge">
        <h3>TÃ¤gliche Herausforderung</h3>
        <p id="daily-challenge-desc">Beantworte 5 Fragen richtig in einem Quiz</p>
        <div class="daily-challenge-status" id="daily-challenge-status">0/5 geschafft</div>
        <div class="daily-challenge-reward" id="daily-challenge-reward">Belohnung: 50 XP</div>
    </div>
    
    <!-- Login Streak -->
    <div class="login-streak" id="login-streak">
        <!-- Wird dynamisch mit JavaScript gefÃ¼llt -->
    </div>
    
    <div id="quiz-container"></div>
    
    <div class="score-container">
        <div class="score" id="score">Punktzahl: 0 Punkte ğŸ“Š</div>
        <div id="xp-display">XP: 0/100</div>
    </div>
    
    <div class="total-xp">Gesamt-XP: <span id="total-xp">0</span></div>
    
    <!-- Fortschrittspfad -->
    <div class="progress-path">
        <h3>Dein Lernfortschritt ğŸ“š</h3>
        <div class="progress-path-line">
            <div class="progress-path-fill" id="progress-path-fill"></div>
            <div class="progress-milestone" style="left: 10%" id="milestone-1" title="AnfÃ¤nger">ğŸ¥‰</div>
            <div class="progress-milestone" style="left: 30%" id="milestone-2" title="Fortgeschritten">ğŸ¥ˆ</div>
            <div class="progress-milestone" style="left: 60%" id="milestone-3" title="Profi">ğŸ¥‡</div>
            <div class="progress-milestone" style="left: 90%" id="milestone-4" title="Meister">ğŸ‘‘</div>
        </div>
        <div id="path-status" class="path-status">Sammle XP, um auf deinem Lernpfad voranzuschreiten!</div>
    </div>
    
    <div class="badge-container" id="badge-container">
        <div class="badge" id="badge-beginner">
            <div class="badge-icon">ğŸ¥‰</div>
            <div class="badge-name">AnfÃ¤nger (100 XP)</div>
        </div>
        <div class="badge" id="badge-intermediate">
            <div class="badge-icon">ğŸ¥ˆ</div>
            <div class="badge-name">Fortgeschritten (350 XP)</div>
        </div>
        <div class="badge" id="badge-advanced">
            <div class="badge-icon">ğŸ¥‡</div>
            <div class="badge-name">Profi (750 XP)</div>
        </div>
        <div class="badge" id="badge-master">
            <div class="badge-icon">ğŸ‘‘</div>
            <div class="badge-name">Meister (1500 XP)</div>
        </div>
    </div>
    
    <div class="stats-container hidden" id="stats-container">
        <h2>Deine Statistiken ğŸ“ˆ</h2>
        <p>Gespielte Quizze: <span id="total-quizzes">0</span></p>
        <p>Korrekte Antworten: <span id="total-correct">0</span></p>
        <p>Durchschnittliche Punktzahl: <span id="average-score">0</span></p>
        <p>LÃ¤ngste Streak: <span id="best-streak">0</span></p>
        <p>Verdiente Badges: <span id="earned-badges">0</span>/4</p>
    </div>

    <!-- Achievement popup -->
    <div class="achievement-popup" id="achievement-popup">
        <h2 id="achievement-title">Achievement Unlocked!</h2>
        <div class="badge-icon" id="achievement-icon">ğŸ†</div>
        <p id="achievement-description">Du hast etwas GroÃŸartiges erreicht!</p>
        <button onclick="closeAchievementPopup()">Super!</button>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Bonus-Popup -->
    <div class="bonus-popup" id="bonus-popup"></div>

    <script>
        // Fragen-Array wird durch asynchrones Laden ersetzt
        let questions = [];
        
        // Lade die Fragen beim Start
        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error('Fehler beim Laden der Fragen');
                }
                const data = await response.json();
                questions = data.questions;
                // Starte das Quiz erst nach dem Laden der Fragen
                loadSavedData();
                newQuiz();
            } catch (error) {
                console.error('Fehler beim Laden der Fragen:', error);
                document.getElementById('quiz-container').innerHTML = 
                    '<div class="error-message">Fehler beim Laden der Fragen. Bitte aktualisiere die Seite.</div>';
            }
        }

        // Game state
        let currentQuestions = [];
        let score = 0;
        let xp = 0;
        let totalXP = 0;
        let level = 1;
        let darkMode = true;
        let currentStreak = 0;
        let bestStreak = 0;
        let totalCorrect = 0;
        let totalQuestions = 0;
        let totalQuizzes = 0;
        let badges = {
            beginner: false,  // 100 XP
            intermediate: false,  // 350 XP
            advanced: false,  // 750 XP
            master: false     // 1500 XP
        };
        
        // Hinweis-System und Power-Ups
        let hintCoins = 0;
        let powerUps = {
            removeWrong: 0,
            showHint: 0,
            extraTime: 0
        };
        let currentQuestionIndex = -1; // Aktuell ausgewÃ¤hlte Frage fÃ¼r Power-Ups
        let powerUpPrices = {
            removeWrong: 10,
            showHint: 5,
            extraTime: 8
        };
        
        // Neue Gamification-Features
        let dailyChallenge = {
            type: 'answer5',
            progress: 0,
            target: 5,
            completed: false,
            reward: 50,
            lastReset: null
        };
        
        let loginStreak = {
            currentStreak: 0,
            lastLogin: null,
            rewards: [5, 10, 15, 20, 25, 30, 50]
        };
        
        // Cache fÃ¼r gestellte Fragen
        let recentlyAskedQuestions = [];
        const MAX_CACHE_SIZE = 10; // Speichert die letzten 10 Fragen
        
        // Feedback-Variationen
        const successFeedbacks = [
            "GroÃŸartig! +{xp} XP!",
            "Sehr gut! +{xp} XP!",
            "Korrekt! +{xp} XP!",
            "Hervorragend! +{xp} XP!",
            "Das stimmt! +{xp} XP!",
            "Richtig! +{xp} XP!",
            "Du bist auf dem richtigen Weg! +{xp} XP!",
            "Perfekt! +{xp} XP!",
            "Gut gemacht! +{xp} XP!"
        ];

        const errorFeedbacks = [
            "Das war leider falsch. Versuche es weiter!",
            "Nicht ganz richtig. Probiere die nÃ¤chste Frage!",
            "Falsche Antwort, aber kein Problem!",
            "Das ist nicht die richtige Antwort. Weiter geht's!",
            "Leider nicht korrekt. Du schaffst das!",
            "Nicht richtig, aber lass dich nicht entmutigen!"
        ];

        // Load saved data if available
        function loadSavedData() {
            const savedData = localStorage.getItem('hardwareQuizData');
            if (savedData) {
                const data = JSON.parse(savedData);
                level = data.level || 1;
                xp = data.xp || 0;
                totalXP = data.totalXP || 0;
                totalCorrect = data.totalCorrect || 0;
                totalQuestions = data.totalQuestions || 0;
                totalQuizzes = data.totalQuizzes || 0;
                bestStreak = data.bestStreak || 0;
                badges = data.badges || {
                    beginner: false,
                    intermediate: false,
                    advanced: false,
                    master: false
                };
                darkMode = data.darkMode !== undefined ? data.darkMode : true;
                recentlyAskedQuestions = data.recentlyAskedQuestions || [];
                
                // Lade gespeicherte Gamification-Daten
                dailyChallenge = data.dailyChallenge || dailyChallenge;
                loginStreak = data.loginStreak || loginStreak;
                
                // Lade Hinweis-System Daten
                hintCoins = data.hintCoins || 0;
                powerUps = data.powerUps || {
                    removeWrong: 0,
                    showHint: 0,
                    extraTime: 0
                };
                
                updateLevel();
                updateBadges();
                updateStats();
                updateHintSystem();
                document.getElementById('total-xp').textContent = totalXP;
                
                // ÃœberprÃ¼fe und aktualisiere die tÃ¤gliche Herausforderung
                checkDailyReset();
                updateDailyChallengeUI();
                
                // ÃœberprÃ¼fe und aktualisiere Login-Streak
                checkLoginStreak();
                updateLoginStreakUI();
                
                // Timer-Modus
                if (data.timerActive) {
                    timerActive = data.timerActive;
                    toggleTimerMode();
                }
                
                updateProgressPath();
            }
        }

        // Save game data
        function saveGameData() {
            const gameData = {
                level,
                xp,
                totalXP,
                totalCorrect,
                totalQuestions,
                totalQuizzes,
                bestStreak,
                badges,
                darkMode,
                recentlyAskedQuestions,
                dailyChallenge,
                loginStreak,
                hintCoins,
                powerUps,
                timerActive
            };
            localStorage.setItem('hardwareQuizData', JSON.stringify(gameData));
        }

        // Update Hinweis-System UI
        function updateHintSystem() {
            document.getElementById('hint-coins-count').textContent = hintCoins;
            document.getElementById('removeWrong-count').textContent = powerUps.removeWrong;
            document.getElementById('showHint-count').textContent = powerUps.showHint;
            document.getElementById('extraTime-count').textContent = powerUps.extraTime;
        }

        // Power-Ups kaufen
        function buyPowerUp(type) {
            const price = powerUpPrices[type];
            if (hintCoins >= price) {
                hintCoins -= price;
                powerUps[type]++;
                
                showBonusPopup(`${type} Power-Up erhalten! ğŸ`);
                updateHintSystem();
                saveGameData();
            } else {
                showBonusPopup('Nicht genug MÃ¼nzen! ğŸ’¸');
            }
        }

        // Power-Ups verwenden
        function usePowerUp(type) {
            if (powerUps[type] <= 0) {
                showBonusPopup('Du hast kein Power-Up dieser Art! ğŸš«');
                return;
            }
            
            // Finde die aktuelle Frage
            if (currentQuestionIndex === -1) {
                // Suche nach der ersten unbeantworteten Frage
                const questionContainers = document.querySelectorAll('.question-container');
                for (let i = 0; i < questionContainers.length; i++) {
                    const options = questionContainers[i].querySelectorAll('.option');
                    let answered = false;
                    options.forEach(option => {
                        if (option.classList.contains('correct') || option.classList.contains('incorrect')) {
                            answered = true;
                        }
                    });
                    
                    if (!answered) {
                        currentQuestionIndex = i;
                        break;
                    }
                }
            }
            
            if (currentQuestionIndex === -1) {
                showBonusPopup('Keine unbeantwortete Frage gefunden! ğŸ¤”');
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            const questionContainer = document.getElementById(`question-${currentQuestionIndex}`);
            
            switch(type) {
                case 'removeWrong':
                    // Entferne zwei falsche Antworten
                    const options = questionContainer.querySelectorAll('.option');
                    const correctIndex = question.randomizedCorrect;
                    
                    // Sammle Indizes aller falschen Antworten
                    const wrongIndices = [];
                    for (let i = 0; i < options.length; i++) {
                        if (i !== correctIndex) {
                            wrongIndices.push(i);
                        }
                    }
                    
                    // Mische die falschen Antworten und wÃ¤hle zwei aus
                    shuffleArray(wrongIndices);
                    const toRemove = wrongIndices.slice(0, 2);
                    
                    // Entferne die ausgewÃ¤hlten falschen Antworten
                    toRemove.forEach(index => {
                        options[index].style.opacity = '0.3';
                        options[index].style.pointerEvents = 'none';
                    });
                    
                    showBonusPopup('2 falsche Antworten entfernt! ğŸ¯');
                    break;
                    
                case 'showHint':
                    // Zeige einen Hinweis fÃ¼r die Frage
                    if (!question.hint) {
                        showBonusPopup('Kein Hinweis verfÃ¼gbar! ğŸ˜•');
                        return;
                    }
                    
                    // Erstelle Hinweis-Element
                    const hintElement = document.createElement('div');
                    hintElement.className = 'hint-message';
                    hintElement.innerHTML = `<strong>Hinweis:</strong> ${question.hint}`;
                    
                    // FÃ¼ge Hinweis zur Frage hinzu
                    const questionTitle = questionContainer.querySelector('h3');
                    questionTitle.insertAdjacentElement('afterend', hintElement);
                    
                    showBonusPopup('Hinweis angezeigt! ğŸ’¡');
                    break;
                    
                case 'extraTime':
                    // Bei Timer-Modus wird extra Zeit hinzugefÃ¼gt
                    if (timerActive) {
                        timeRemaining += 15; // 15 Sekunden extra
                        updateTimer();
                        showBonusPopup('15 Sekunden extra Zeit! â±ï¸');
                    } else {
                        showBonusPopup('Zeitmodus ist nicht aktiv! â±ï¸');
                        return;
                    }
                    break;
            }
            
            // Power-Up verbrauchen
            powerUps[type]--;
            updateHintSystem();
            saveGameData();
        }

        // Bonus-Popup anzeigen
        function showBonusPopup(message) {
            const popup = document.getElementById('bonus-popup');
            popup.textContent = message;
            popup.style.opacity = '1';
            
            setTimeout(() => {
                popup.style.opacity = '0';
            }, 2000);
        }

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            darkMode = false;
        }

        function initTheme() {
            document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            document.querySelector('.fixed-header').style.backgroundColor = 
                darkMode ? 'var(--bg-color)' : 'var(--bg-color)';
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            document.querySelector('.fixed-header').style.backgroundColor = 
                darkMode ? 'var(--bg-color)' : 'var(--bg-color)';
            saveGameData();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectRandomQuestions() {
            let availableQuestions = [...questions];
            
            // Filtere kÃ¼rzlich gestellte Fragen heraus, wenn mÃ¶glich
            if (recentlyAskedQuestions.length > 0 && availableQuestions.length > recentlyAskedQuestions.length) {
                availableQuestions = availableQuestions.filter(q => 
                    !recentlyAskedQuestions.some(rq => rq.question === q.question)
                );
            }
            
            const shuffled = shuffleArray(availableQuestions);
            const selected = shuffled.slice(0, 20);
            
            // Aktualisiere den Fragen-Cache
            selected.forEach(q => {
                // FÃ¼ge die Frage zum Cache hinzu
                recentlyAskedQuestions.push(q);
                
                // Halte die GrÃ¶ÃŸe des Caches unter Kontrolle
                if (recentlyAskedQuestions.length > MAX_CACHE_SIZE) {
                    recentlyAskedQuestions.shift();
                }
            });
            
            return selected;
        }

        function celebrateSuccess() {
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                });
                confetti({
                    ...defaults,
                    particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                });
            }, 250);
        }

        function showAchievementPopup(title, icon, description) {
            document.getElementById('achievement-title').textContent = title;
            document.getElementById('achievement-icon').textContent = icon;
            document.getElementById('achievement-description').textContent = description;
            
            document.getElementById('achievement-popup').classList.add('show');
            document.getElementById('overlay').classList.add('show');
            
            celebrateSuccess();
        }

        function closeAchievementPopup() {
            document.getElementById('achievement-popup').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        function updateProgressBar() {
            const percent = Math.min(100, Math.round((score / 20) * 100));
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-label').textContent = `${percent}%`;
        }

        function updateStreak(isCorrect) {
            if (isCorrect) {
                currentStreak++;
                document.getElementById('streak-flame').classList.add('active');
            } else {
                currentStreak = 0;
                document.getElementById('streak-flame').classList.remove('active');
            }
            
            if (currentStreak > bestStreak) {
                bestStreak = currentStreak;
            }
            
            document.getElementById('streak-text').textContent = `Aktuelle Serie: ${currentStreak}`;
        }

        function updateLevel() {
            const xpNeeded = level * 100; // Konsistente XP-Berechnung mit 100 XP pro Level
            
            if (xp >= xpNeeded && level < 10) {
                xp -= xpNeeded;
                level++;
                celebrateSuccess();
                showFeedback(`ğŸ‰ GlÃ¼ckwunsch! Du hast Level ${level} erreicht!`, true);
            }
            
            document.getElementById('level').textContent = level;
            document.getElementById('xp-display').textContent = `XP: ${xp}/${level * 100}`;
        }

        function checkForBadges() {
            // Speichere bisherigen Badge-Status
            const previousBadges = {...badges};
            const unlockedBadges = [];
            
            // ÃœberprÃ¼fe alle Badges gleichzeitig
            if (totalXP >= 100 && !badges.beginner) {
                badges.beginner = true;
                unlockedBadges.push({
                    title: "AnfÃ¤nger Badge freigeschaltet!",
                    icon: "ğŸ¥‰",
                    description: "Du hast 100 XP gesammelt!"
                });
            }
            
            if (totalXP >= 350 && !badges.intermediate) {
                badges.intermediate = true;
                unlockedBadges.push({
                    title: "Fortgeschrittener Badge freigeschaltet!",
                    icon: "ğŸ¥ˆ",
                    description: "Du hast 350 XP gesammelt!"
                });
            }
            
            if (totalXP >= 750 && !badges.advanced) {
                badges.advanced = true;
                unlockedBadges.push({
                    title: "Profi Badge freigeschaltet!",
                    icon: "ğŸ¥‡",
                    description: "Du hast 750 XP gesammelt!"
                });
            }
            
            if (totalXP >= 1500 && !badges.master) {
                badges.master = true;
                unlockedBadges.push({
                    title: "Meister Badge freigeschaltet!",
                    icon: "ğŸ‘‘",
                    description: "Du hast 1500 XP gesammelt!"
                });
            }
            
            // Zeige alle freigeschalteten Badges nacheinander an
            if (unlockedBadges.length > 0) {
                // Zeige den ersten Badge sofort an
                const firstBadge = unlockedBadges[0];
                showAchievementPopup(firstBadge.title, firstBadge.icon, firstBadge.description);
                
                // Zeige weitere Badges nacheinander an, wenn der vorherige geschlossen wird
                let currentBadgeIndex = 1;
                
                if (unlockedBadges.length > 1) {
                    const showNextBadge = () => {
                        if (currentBadgeIndex < unlockedBadges.length) {
                            const nextBadge = unlockedBadges[currentBadgeIndex];
                            showAchievementPopup(nextBadge.title, nextBadge.icon, nextBadge.description);
                            currentBadgeIndex++;
                        }
                    };
                    
                    // Ãœberwache das SchlieÃŸen des Achievement-Popups
                    document.getElementById('achievement-popup').addEventListener('transitionend', (e) => {
                        if (e.propertyName === 'opacity' && !document.getElementById('achievement-popup').classList.contains('show')) {
                            // VerzÃ¶gere leicht, damit der nÃ¤chste Badge nicht sofort erscheint
                            setTimeout(showNextBadge, 500);
                        }
                    });
                }
            }
            
            // Wenn sich Badge-Status geÃ¤ndert hat, aktualisiere die Anzeige
            if (JSON.stringify(previousBadges) !== JSON.stringify(badges)) {
                updateBadges();
                updateProgressPath(); // Aktualisiere den Fortschrittspfad
            }
        }

        function updateBadges() {
            if (badges.beginner) {
                document.getElementById('badge-beginner').classList.add('earned');
            }
            if (badges.intermediate) {
                document.getElementById('badge-intermediate').classList.add('earned');
            }
            if (badges.advanced) {
                document.getElementById('badge-advanced').classList.add('earned');
            }
            if (badges.master) {
                document.getElementById('badge-master').classList.add('earned');
            }
            
            // Count earned badges
            const earnedCount = Object.values(badges).filter(value => value).length;
            document.getElementById('earned-badges').textContent = earnedCount;
        }

        function updateStats() {
            document.getElementById('total-quizzes').textContent = totalQuizzes;
            document.getElementById('total-correct').textContent = totalCorrect;
            document.getElementById('best-streak').textContent = bestStreak;
            
            const averageScore = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) / 10 : 0;
            document.getElementById('average-score').textContent = averageScore;
        }

        function showFeedback(message, isSuccess) {
            const feedbackElement = document.getElementById('feedback-message');
            feedbackElement.textContent = message;
            feedbackElement.className = '';
            feedbackElement.classList.add(isSuccess ? 'feedback-success' : 'feedback-error');
            feedbackElement.style.opacity = 1;
            
            setTimeout(() => {
                feedbackElement.style.opacity = 0;
            }, 3000);
        }

        function getRandomFeedback(isSuccess, xpGained) {
            if (isSuccess) {
                const randomIndex = Math.floor(Math.random() * successFeedbacks.length);
                return successFeedbacks[randomIndex].replace('{xp}', xpGained);
            } else {
                const randomIndex = Math.floor(Math.random() * errorFeedbacks.length);
                return errorFeedbacks[randomIndex];
            }
        }

        function toggleStats() {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.classList.toggle('hidden');
        }

        // ÃœberprÃ¼fe, ob ein neuer Tag begonnen hat und setze die tÃ¤gliche Herausforderung zurÃ¼ck
        function checkDailyReset() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            if (!dailyChallenge.lastReset || dailyChallenge.lastReset < today) {
                // Ein neuer Tag hat begonnen, setze die Herausforderung zurÃ¼ck
                dailyChallenge.lastReset = today;
                dailyChallenge.completed = false;
                dailyChallenge.progress = 0;
                
                // WÃ¤hle eine neue Herausforderung
                const challenges = ['answer5', 'streak3', 'complete1'];
                dailyChallenge.type = challenges[Math.floor(Math.random() * challenges.length)];
                
                switch (dailyChallenge.type) {
                    case 'answer5':
                        dailyChallenge.target = 5;
                        dailyChallenge.reward = 50;
                        break;
                    case 'streak3':
                        dailyChallenge.target = 3;
                        dailyChallenge.reward = 30;
                        break;
                    case 'complete1':
                        dailyChallenge.target = 1;
                        dailyChallenge.reward = 100;
                        break;
                }
                
                saveGameData();
            }
        }
        
        // Aktualisiere die UI fÃ¼r die tÃ¤gliche Herausforderung
        function updateDailyChallengeUI() {
            const descElement = document.getElementById('daily-challenge-desc');
            const statusElement = document.getElementById('daily-challenge-status');
            const rewardElement = document.getElementById('daily-challenge-reward');
            
            let desc = '';
            switch (dailyChallenge.type) {
                case 'answer5':
                    desc = 'Beantworte 5 Fragen richtig in einem Quiz';
                    break;
                case 'streak3':
                    desc = 'Erreiche eine Serie von 3 richtigen Antworten';
                    break;
                case 'complete1':
                    desc = 'SchlieÃŸe ein Quiz vollstÃ¤ndig ab';
                    break;
            }
            
            descElement.textContent = desc;
            statusElement.textContent = `${dailyChallenge.progress}/${dailyChallenge.target} geschafft`;
            rewardElement.textContent = `Belohnung: ${dailyChallenge.reward} XP`;
            
            const challengeContainer = document.getElementById('daily-challenge');
            if (dailyChallenge.completed) {
                challengeContainer.classList.add('completed');
                statusElement.textContent = 'Abgeschlossen! ğŸ‰';
            } else {
                challengeContainer.classList.remove('completed');
            }
        }
        
        // ÃœberprÃ¼fe und aktualisiere Login-Streak
        function checkLoginStreak() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            if (!loginStreak.lastLogin) {
                // Erster Login Ã¼berhaupt
                loginStreak.lastLogin = today;
                loginStreak.currentStreak = 1;
            } else if (loginStreak.lastLogin < today) {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);
                
                if (loginStreak.lastLogin >= yesterday.getTime()) {
                    // Login an aufeinanderfolgenden Tagen
                    loginStreak.currentStreak++;
                    loginStreak.lastLogin = today;
                    
                    // Belohnung fÃ¼r Login-Streak
                    const dayIndex = Math.min(loginStreak.currentStreak - 1, loginStreak.rewards.length - 1);
                    const reward = loginStreak.rewards[dayIndex];
                    
                    xp += reward;
                    totalXP += reward;
                    showFeedback(`ğŸ”¥ ${loginStreak.currentStreak} Tage in Folge! +${reward} XP`, true);
                    
                    updateLevel();
                    document.getElementById('total-xp').textContent = totalXP;
                } else {
                    // Streak unterbrochen
                    loginStreak.currentStreak = 1;
                    loginStreak.lastLogin = today;
                }
            }
            
            saveGameData();
        }
        
        // Aktualisiere Login-Streak UI
        function updateLoginStreakUI() {
            const container = document.getElementById('login-streak');
            container.innerHTML = '';
            
            // Zeige bis zu 7 Tage an
            const daysToShow = 7;
            
            for (let i = 0; i < daysToShow; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'login-day';
                
                const dayCircle = document.createElement('div');
                dayCircle.className = 'login-day-circle';
                
                // Aktive Tage markieren
                if (i < loginStreak.currentStreak) {
                    dayCircle.classList.add('active');
                }
                
                // Heute markieren
                if (i === loginStreak.currentStreak - 1) {
                    dayCircle.classList.add('today');
                }
                
                dayCircle.textContent = (i + 1).toString();
                
                const dayText = document.createElement('div');
                dayText.className = 'login-day-text';
                dayText.textContent = `Tag ${i + 1}`;
                
                // Belohnungsanzeige
                if (i < loginStreak.rewards.length) {
                    const rewardBadge = document.createElement('div');
                    rewardBadge.className = 'login-day-reward';
                    rewardBadge.textContent = loginStreak.rewards[i];
                    dayDiv.appendChild(rewardBadge);
                }
                
                dayDiv.appendChild(dayCircle);
                dayDiv.appendChild(dayText);
                container.appendChild(dayDiv);
            }
        }
        
        // Aktualisiere den Fortschritt der tÃ¤glichen Herausforderung
        function updateDailyChallenge(type) {
            if (dailyChallenge.completed) return;
            
            switch (dailyChallenge.type) {
                case 'answer5':
                    if (type === 'correct_answer') {
                        dailyChallenge.progress++;
                    }
                    break;
                case 'streak3':
                    if (type === 'streak_update' && currentStreak > dailyChallenge.progress) {
                        dailyChallenge.progress = currentStreak;
                    }
                    break;
                case 'complete1':
                    if (type === 'quiz_complete') {
                        dailyChallenge.progress++;
                    }
                    break;
            }
            
            if (dailyChallenge.progress >= dailyChallenge.target) {
                dailyChallenge.completed = true;
                xp += dailyChallenge.reward;
                totalXP += dailyChallenge.reward;
                
                setTimeout(() => {
                    showAchievementPopup('TÃ¤gliche Herausforderung abgeschlossen!', 'ğŸ†', `Du hast ${dailyChallenge.reward} XP erhalten!`);
                    updateLevel();
                    document.getElementById('total-xp').textContent = totalXP;
                }, 1000);
            }
            
            updateDailyChallengeUI();
            saveGameData();
        }

        // Timer-Modus
        let timerActive = false;
        let timeRemaining = 0;
        let maxTime = 0;
        let timerInterval = null;
        
        // Timer einschalten/ausschalten
        function toggleTimerMode() {
            timerActive = !timerActive;
            const timerContainer = document.getElementById('timer-container');
            const timerToggleBtn = document.getElementById('timer-toggle');
            
            if (timerActive) {
                timerContainer.style.display = 'block';
                timerToggleBtn.textContent = 'â±ï¸ Zeitmodus (AN)';
                timerToggleBtn.style.backgroundColor = 'var(--time-color)';
                
                // Starte den Timer fÃ¼r die aktuelle Frage
                startQuestionTimer();
            } else {
                timerContainer.style.display = 'none';
                timerToggleBtn.textContent = 'â±ï¸ Zeitmodus';
                timerToggleBtn.style.backgroundColor = 'var(--primary-color)';
                
                // Stoppe den Timer
                clearInterval(timerInterval);
            }
            
            saveGameData();
        }
        
        // Timer fÃ¼r aktuelle Frage starten
        function startQuestionTimer() {
            if (!timerActive) return;
            
            // Stoppe vorherigen Timer
            clearInterval(timerInterval);
            
            // Setze Timer je nach Schwierigkeit der Frage
            // Zwischen 15 und 30 Sekunden, abhÃ¤ngig von der FragelÃ¤nge und OptionslÃ¤nge
            const currentQuestion = currentQuestions[currentQuestionIndex];
            
            if (!currentQuestion) return; // Keine aktuelle Frage
            
            const questionLength = currentQuestion.question.length;
            const optionsLength = currentQuestion.options.reduce((sum, opt) => sum + opt.length, 0);
            
            // Zeitberechnung: Basiszeit + Bonus fÃ¼r lÃ¤ngere Fragen/Optionen
            maxTime = 15 + Math.min(15, Math.floor((questionLength + optionsLength) / 20));
            timeRemaining = maxTime;
            
            updateTimer();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimer();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    
                    // Automatisch eine falsche Antwort auswÃ¤hlen
                    const questionContainer = document.getElementById(`question-${currentQuestionIndex}`);
                    const options = questionContainer.querySelectorAll('.option');
                    
                    // Finde eine falsche Option
                    let wrongOptionIndex = 0;
                    if (wrongOptionIndex === currentQuestion.randomizedCorrect) {
                        wrongOptionIndex = 1; // WÃ¤hle stattdessen die zweite Option
                    }
                    
                    // Simuliere Klick auf falsche Option
                    setTimeout(() => {
                        checkAnswer(currentQuestionIndex, wrongOptionIndex);
                        showBonusPopup('Zeit abgelaufen! âŒ›');
                        
                        // Finde die nÃ¤chste unbeantwortete Frage
                        findNextUnansweredQuestion();
                    }, 500);
                }
            }, 1000);
        }
        
        // Timer-Balken aktualisieren
        function updateTimer() {
            const timerBar = document.getElementById('timer-bar');
            const percent = (timeRemaining / maxTime) * 100;
            timerBar.style.width = `${percent}%`;
            
            // Farbe Ã¤ndern, je nach verbleibender Zeit
            if (percent > 50) {
                timerBar.style.backgroundColor = 'var(--success-color)';
            } else if (percent > 20) {
                timerBar.style.backgroundColor = 'var(--gold-color)';
            } else {
                timerBar.style.backgroundColor = 'var(--danger-color)';
            }
        }
        
        // Finde die nÃ¤chste unbeantwortete Frage
        function findNextUnansweredQuestion() {
            const questionContainers = document.querySelectorAll('.question-container');
            
            for (let i = 0; i < questionContainers.length; i++) {
                const options = questionContainers[i].querySelectorAll('.option');
                let answered = false;
                
                options.forEach(option => {
                    if (option.classList.contains('correct') || option.classList.contains('incorrect')) {
                        answered = true;
                    }
                });
                
                if (!answered) {
                    currentQuestionIndex = i;
                    startQuestionTimer();
                    return;
                }
            }
            
            // Keine unbeantwortete Frage gefunden
            currentQuestionIndex = -1;
        }
        
        // Zeige Zeitbonus
        function showTimeBonus(bonusXp) {
            const bonusElement = document.getElementById('time-bonus');
            bonusElement.textContent = `+${bonusXp} XP`;
            bonusElement.classList.add('show');
            
            setTimeout(() => {
                bonusElement.classList.remove('show');
            }, 1500);
        }

        function checkAnswer(questionIndex, selectedOption) {
            currentQuestionIndex = questionIndex; // Setze aktuelle Frage fÃ¼r Power-Ups
            
            const question = currentQuestions[questionIndex];
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            const isCorrect = selectedOption === question.randomizedCorrect;
            
            totalQuestions++;

            // Stoppe Timer
            clearInterval(timerInterval);

            options.forEach((option, index) => {
                if (index === question.randomizedCorrect) {
                    option.classList.add('correct');
                }
                if (index === selectedOption && index !== question.randomizedCorrect) {
                    option.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                score++;
                totalCorrect++;
                
                // Base points
                const basePoints = 5;
                
                // Bonus points for streak
                const streakBonus = currentStreak > 0 ? Math.min(5, currentStreak) : 0;
                
                // Level bonus
                const levelBonus = Math.floor(level / 2);
                
                // Zeitbonus, wenn Timer aktiv
                let timeBonus = 0;
                if (timerActive && timeRemaining > 0) {
                    timeBonus = Math.ceil(timeRemaining / maxTime * 5); // Max 5 XP Bonus fÃ¼r schnelle Antworten
                    showTimeBonus(timeBonus);
                }
                
                // Calculate total XP gained
                const xpGained = basePoints + streakBonus + levelBonus + timeBonus;
                xp += xpGained;
                totalXP += xpGained;
                
                // GewÃ¤hre MÃ¼nzen fÃ¼r richtige Antworten
                const coinsEarned = 1 + Math.floor(level / 3); // Mehr MÃ¼nzen mit hÃ¶herem Level
                hintCoins += coinsEarned;
                
                document.getElementById('score').textContent = `Punktzahl: ${score} Punkte ğŸ“Š`;
                document.getElementById('total-xp').textContent = totalXP;
                updateProgressBar();
                updateLevel();
                updateHintSystem();
                updateProgressPath(); // Aktualisiere den Fortschrittspfad
                
                // Verwende abwechslungsreiche Feedback-Nachrichten
                let feedbackText = getRandomFeedback(true, xpGained);
                if (streakBonus > 0) feedbackText += ` (+${streakBonus} Streak Bonus)`;
                if (timeBonus > 0) feedbackText += ` (+${timeBonus} Zeit Bonus)`;
                feedbackText += ` (+${coinsEarned} ğŸª™)`;
                
                showFeedback(feedbackText, true);
                
                document.getElementById('score').classList.add('pop-animation');
                setTimeout(() => {
                    document.getElementById('score').classList.remove('pop-animation');
                }, 500);

                if (score === 20) {
                    celebrateSuccess();
                    totalQuizzes++;
                    
                    // Bonus MÃ¼nzen fÃ¼r vollstÃ¤ndiges Quiz
                    const bonusCoins = 10;
                    hintCoins += bonusCoins;
                    updateHintSystem();
                    
                    // Update tÃ¤gliche Herausforderung fÃ¼r abgeschlossenes Quiz
                    updateDailyChallenge('quiz_complete');
                    
                    setTimeout(() => {
                        alert(`ğŸ‰ Perfekt! Du hast alle Fragen richtig beantwortet! +${bonusCoins} Bonus-MÃ¼nzen! ğŸ†`);
                    }, 500);
                }
                
                // Aktualisiere tÃ¤gliche Herausforderung
                updateDailyChallenge('correct_answer');
                
                // Check for badge unlocks based on total XP
                checkForBadges();
            } else {
                // Verwende abwechslungsreiche Fehler-Feedback-Nachrichten
                showFeedback(getRandomFeedback(false), false);
            }
            
            updateStreak(isCorrect);
            // Aktualisiere die Streak-Herausforderung wenn nÃ¶tig
            updateDailyChallenge('streak_update');
            
            saveGameData();
            updateStats();

            options.forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            // Finde die nÃ¤chste unbeantwortete Frage und starte Timer fÃ¼r diese (wenn Timer-Modus aktiv)
            if (timerActive) {
                setTimeout(() => {
                    findNextUnansweredQuestion();
                }, 1000);
            }
        }

        function createQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            score = 0;
            document.getElementById('score').textContent = 'Punktzahl: 0 Punkte ğŸ“Š';
            updateProgressBar();

            currentQuestions.forEach((question, questionIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.id = `question-${questionIndex}`;

                // Randomize options but keep track of correct answer
                const originalCorrectIndex = question.correct;
                const optionsCopy = [...question.options];
                const randomizedOptions = [];
                const optionMapping = []; // Maps new indices to original indices
                
                // Randomly select options until none remain
                while (optionsCopy.length > 0) {
                    const randIndex = Math.floor(Math.random() * optionsCopy.length);
                    const originalIndex = question.options.indexOf(optionsCopy[randIndex]);
                    randomizedOptions.push(optionsCopy[randIndex]);
                    optionMapping.push(originalIndex);
                    optionsCopy.splice(randIndex, 1);
                }
                
                // Find new position of correct answer
                const newCorrectIndex = optionMapping.indexOf(originalCorrectIndex);
                
                // Store the new correct index in the current question object
                currentQuestions[questionIndex].randomizedCorrect = newCorrectIndex;

                questionDiv.innerHTML = `
                    <h3>Frage ${questionIndex + 1}</h3>
                    <p>${question.question}</p>
                    ${randomizedOptions.map((option, index) => `
                        <div class="option" onclick="checkAnswer(${questionIndex}, ${index})">${option}</div>
                    `).join('')}
                `;

                container.appendChild(questionDiv);
            });
            
            // Bei Timer-Modus, automatisch mit der ersten Frage beginnen
            if (timerActive) {
                currentQuestionIndex = 0;
                setTimeout(() => {
                    startQuestionTimer();
                }, 500);
            }
        }

        function newQuiz() {
            currentQuestions = selectRandomQuestions();
            createQuiz();
            currentStreak = 0;
            document.getElementById('streak-text').textContent = `Aktuelle Serie: ${currentStreak}`;
            document.getElementById('streak-flame').classList.remove('active');
        }

        // Fix header on scroll
        window.addEventListener('scroll', function() {
            const header = document.querySelector('.fixed-header');
            header.style.backgroundColor = darkMode ? 'var(--bg-color)' : 'var(--bg-color)';
        });

        // Initialize the game
        initTheme();
        // loadSavedData und newQuiz werden jetzt erst nach dem Laden der Fragen aufgerufen
        loadQuestions();

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            darkMode = event.matches;
            document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            document.querySelector('.fixed-header').style.backgroundColor = 
                darkMode ? 'var(--bg-color)' : 'var(--bg-color)';
            saveGameData();
        });
        
        // Aktualisiere den Fortschrittspfad basierend auf totalXP
        function updateProgressPath() {
            const xpNeededForMaster = 1500;
            const progressPercent = Math.min(100, (totalXP / xpNeededForMaster) * 100);
            
            document.getElementById('progress-path-fill').style.width = `${progressPercent}%`;
            
            // Aktualisiere die Meilensteine
            const milestone1 = document.getElementById('milestone-1');
            const milestone2 = document.getElementById('milestone-2');
            const milestone3 = document.getElementById('milestone-3');
            const milestone4 = document.getElementById('milestone-4');
            
            // Setze alle Meilensteine zurÃ¼ck
            milestone1.classList.remove('active', 'completed');
            milestone2.classList.remove('active', 'completed');
            milestone3.classList.remove('active', 'completed');
            milestone4.classList.remove('active', 'completed');
            
            // Status-Nachricht aktualisieren
            let pathStatus = '';
            
            // Meilensteine basierend auf erreichtem Fortschritt aktivieren
            if (totalXP >= 1500) {
                milestone1.classList.add('completed');
                milestone2.classList.add('completed');
                milestone3.classList.add('completed');
                milestone4.classList.add('completed');
                pathStatus = 'ğŸ“ Gratulation! Du hast den Meister-Level erreicht!';
            } else if (totalXP >= 750) {
                milestone1.classList.add('completed');
                milestone2.classList.add('completed');
                milestone3.classList.add('completed');
                milestone4.classList.add('active');
                pathStatus = `ğŸ¥‡ Du bist ein Profi! Noch ${1500 - totalXP} XP bis zum Meister-Level.`;
            } else if (totalXP >= 350) {
                milestone1.classList.add('completed');
                milestone2.classList.add('completed');
                milestone3.classList.add('active');
                pathStatus = `ğŸ¥ˆ Du bist fortgeschritten! Noch ${750 - totalXP} XP bis zum Profi-Level.`;
            } else if (totalXP >= 100) {
                milestone1.classList.add('completed');
                milestone2.classList.add('active');
                pathStatus = `ğŸ¥‰ Du bist Ã¼ber den AnfÃ¤nger-Level hinaus! Noch ${350 - totalXP} XP bis zum Fortgeschrittenen-Level.`;
            } else {
                milestone1.classList.add('active');
                pathStatus = `ğŸŒ± Du bist am Beginn deiner Lernreise! Noch ${100 - totalXP} XP bis zum AnfÃ¤nger-Level.`;
            }
            
            document.getElementById('path-status').textContent = pathStatus;
        }
    </script>
</body>
</html>